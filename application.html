<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Property - ForRentbyOwner</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Modern CSS Framework (for header/footer) -->
    <link rel="stylesheet" href="modern-framework.css?v=2.0">

    <!-- Application Page Styles -->
    <link rel="stylesheet" href="css/application.css">

    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
    </style>
</head>

<body>
    <!-- Header Navigation -->
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="logo-text">
                        <h1>ForRentbyOwner</h1>
                        <p>Premium Property Rentals</p>
                    </div>
                </div>

                <nav class="main-nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="our-properties.html" class="nav-link">Properties</a>
                    <a href="contact.html" class="nav-link">Contact</a>
                </nav>

                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Application Page -->
    <div class="application-page">
        <!-- Hero Section -->
        <section class="application-hero">
            <div class="application-container">
                <h1 id="page-title">Apply for Your Next Home</h1>
                <p>Complete your application in minutes. We'll review and get back to you within 24 hours.</p>
            </div>
        </section>

        <!-- Main Content -->
        <div class="application-container">
            <div class="application-layout">
                <!-- Main Form Column -->
                <div class="form-column">
                    <div class="application-form-card">
                        <form id="property-application-form">
                            <input type="hidden" id="propertyId" name="propertyId" value="">

                            <!-- Personal Information Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h2>Personal Information</h2>
                                    <p>Tell us about yourself</p>
                                </div>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="applicant-name">
                                            Full Name <span class="required">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="applicant-name"
                                            name="applicant-name" placeholder="John Doe" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="applicant-email">
                                            Email Address <span class="required">*</span>
                                        </label>
                                        <input type="email" class="form-control" id="applicant-email"
                                            name="applicant-email" placeholder="john@example.com" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="applicant-phone">
                                            Phone Number <span class="required">*</span>
                                        </label>
                                        <input type="tel" class="form-control" id="applicant-phone"
                                            name="applicant-phone" placeholder="(555) 123-4567" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="applicant-income">
                                            Annual Household Income <span class="required">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="applicant-income"
                                                name="applicant-income" placeholder="75000" min="0" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Residence Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h2>Current Residence</h2>
                                    <p>Where do you currently live?</p>
                                </div>

                                <div class="form-grid single-column">
                                    <div class="form-group">
                                        <label for="applicant-address">
                                            Street Address <span class="required">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="applicant-address"
                                            name="applicant-address" placeholder="123 Main Street" required>
                                    </div>
                                </div>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="applicant-city">
                                            City <span class="required">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="applicant-city"
                                            name="applicant-city" placeholder="Philadelphia" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="applicant-state">
                                            State <span class="required">*</span>
                                        </label>
                                        <select class="form-control" id="applicant-state" name="applicant-state"
                                            required>
                                            <option value="">Select State</option>
                                            <option value="DE">Delaware</option>
                                            <option value="NJ">New Jersey</option>
                                            <option value="PA">Pennsylvania</option>
                                            <option value="NY">New York</option>
                                            <option value="MD">Maryland</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="applicant-zip">
                                            ZIP Code <span class="required">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="applicant-zip" name="applicant-zip"
                                            placeholder="19103" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Employment & Household Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h2>Employment & Household</h2>
                                    <p>Additional information about your household</p>
                                </div>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="applicant-employment">
                                            Current Employer <span class="required">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="applicant-employment"
                                            name="applicant-employment" placeholder="Company Name" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="applicant-occupants">
                                            Total Occupants <span class="required">*</span>
                                        </label>
                                        <input type="number" class="form-control" id="applicant-occupants"
                                            name="applicant-occupants" placeholder="2" min="1" required>
                                    </div>
                                </div>

                                <div class="form-grid single-column">
                                    <div class="form-group">
                                        <label for="applicant-message">
                                            Additional Notes or Special Requirements
                                        </label>
                                        <textarea class="form-control" id="applicant-message" name="applicant-message"
                                            rows="4"
                                            placeholder="Pets, preferred move-in date, or any other details..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Documents Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h2>Required Documents</h2>
                                    <p>Upload your documents now to speed up the approval process by 24 hours.</p>
                                </div>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="doc-id">
                                            Government ID <span class="required">*</span>
                                            <span
                                                style="display:block; font-size: 0.85em; color: var(--text-secondary); font-weight: normal;">(Driver's
                                                License, Passport)</span>
                                        </label>
                                        <input type="file" class="form-control" id="doc-id" name="doc-id"
                                            accept=".pdf,.jpg,.jpeg,.png" required>
                                        <div class="file-feedback" id="feedback-id"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="doc-income">
                                            Proof of Income <span class="required">*</span>
                                            <span
                                                style="display:block; font-size: 0.85em; color: var(--text-secondary); font-weight: normal;">(Pay
                                                stubs, Bank Statement - Last 2 months)</span>
                                        </label>
                                        <input type="file" class="form-control" id="doc-income" name="doc-income"
                                            accept=".pdf,.jpg,.jpeg,.png" required>
                                        <div class="file-feedback" id="feedback-income"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="doc-other">
                                            Other Documents (Optional)
                                            <span
                                                style="display:block; font-size: 0.85em; color: var(--text-secondary); font-weight: normal;">(References,
                                                Pet Records)</span>
                                        </label>
                                        <input type="file" class="form-control" id="doc-other" name="doc-other"
                                            accept=".pdf,.jpg,.jpeg,.png" multiple>
                                        <div class="file-feedback" id="feedback-other"></div>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.85em; color: var(--text-muted);">
                                    <i class="fas fa-info-circle"></i> Supported formats: PDF, JPG, PNG. Max size: 5MB
                                    per file.
                                </div>
                            </div>

                            <!-- Agreement & Submit Section -->
                            <div class="submit-section">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="applicant-terms"
                                        name="applicant-terms" required>
                                    <label class="form-check-label" for="applicant-terms">
                                        I certify that the information provided is true and correct. I authorize the
                                        landlord to verify this information securely. <span class="required">*</span>
                                    </label>
                                </div>

                                <button type="submit" class="btn-primary-large">
                                    <i class="fas fa-lock"></i>
                                    Securely Submit Application
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sidebar Column -->
                <aside class="sidebar-column">
                    <div class="property-summary-card">
                        <h3>Applying For</h3>
                        <div id="property-info-container">
                            <div style="text-align: center; padding: 40px 0;">
                                <div class="spinner"></div>
                                <p style="margin-top: 16px; color: #6B7280; font-size: 14px;">Loading property
                                    details...</p>
                            </div>
                        </div>

                        <div class="requirements-section">
                            <h4>Application Requirements</h4>
                            <ul class="requirements-list">
                                <li><i class="fas fa-check-circle"></i> Valid Government ID</li>
                                <li><i class="fas fa-check-circle"></i> Proof of Income (2 months)</li>
                                <li><i class="fas fa-check-circle"></i> Rental History</li>
                                <li><i class="fas fa-check-circle"></i> Background Check Authorization</li>
                            </ul>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <div class="logo-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <h3>ForRentbyOwner</h3>
                    </div>
                    <p>Privately-owned property rental specialists providing personalized service across Delaware, New
                        Jersey, and Pennsylvania since 2010.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>

                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="our-properties.html">Properties</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>

                <div class="footer-contact">
                    <h4>Contact Info</h4>
                    <ul>
                        <li>
                            <i class="fas fa-phone"></i>
                            <span>(609) 237-5156</span>
                        </li>
                        <li>
                            <i class="fas fa-envelope"></i>
                            <span>Briangorey@zohomail.com</span>
                        </li>
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Delaware, NJ, PA</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2024 ForRentbyOwner. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Get property ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('propertyId');

        // Load property from API
        document.addEventListener('DOMContentLoaded', async function () {
            const propertyInfoContainer = document.getElementById('property-info-container');
            const pageTitle = document.getElementById('page-title');

            if (propertyId) {
                document.getElementById('propertyId').value = propertyId;

                try {
                    const response = await fetch(`/api/properties/${propertyId}`);
                    const result = await response.json();

                    if (result.success) {
                        const property = result.data;
                        const mainImage = property.images && property.images.length > 0 ? property.images[0] : 'IMAGES/default-property.jpg';

                        // Generate mock review data
                        const reviewScore = (8 + Math.random() * 2).toFixed(1);
                        const reviewCount = Math.floor(Math.random() * 5000) + 100;
                        const reviewLabel = reviewScore >= 9 ? 'Superb' : reviewScore >= 8 ? 'Very good' : 'Good';

                        // Update page title
                        pageTitle.textContent = `Apply for ${property.title}`;

                        // Populate property information card
                        propertyInfoContainer.innerHTML = `
                            <div class="property-image-wrapper">
                                <img src="${mainImage}" alt="${property.title}" 
                                     onerror="this.src='IMAGES/default-property.jpg'">
                                <button type="button" class="property-save-btn" aria-label="Save property">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                            
                            <h4 class="property-title">${property.title}</h4>
                            <div class="property-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${property.location}
                            </div>
                            
                            <div class="property-specs">
                                <span><i class="fas fa-bed"></i> ${property.bedrooms} bed</span>
                                <span><i class="fas fa-bath"></i> ${property.bathrooms} bath</span>
                                <span><i class="fas fa-ruler-combined"></i> ${property.squareFeet} sqft</span>
                            </div>
                            
                            <div class="property-rating">
                                <div class="rating-score">${reviewScore}</div>
                                <div class="rating-details">
                                    <div class="rating-label">${reviewLabel}</div>
                                    <div class="rating-count">${reviewCount.toLocaleString()} reviews</div>
                                </div>
                            </div>
                            
                            <div class="property-price-section">
                                <div class="price-label">Monthly rent</div>
                                <div class="price-amount">$${property.price.toLocaleString()}</div>
                                <div class="price-note">Plus utilities and deposits</div>
                                <a href="property-details.html?id=${property.id}" class="view-property-btn">
                                    <i class="fas fa-eye"></i>
                                    View Full Details
                                </a>
                            </div>
                        `;
                    } else {
                        propertyInfoContainer.innerHTML = `
                            <div style="padding: 24px; text-align: center; background: #FEF2F2; border-radius: 8px; color: #991B1B;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p style="margin: 0; font-size: 14px;">Property not found. You can still submit a general application.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading property:', error);
                    propertyInfoContainer.innerHTML = `
                        <div style="padding: 24px; text-align: center; background: #FEF2F2; border-radius: 8px; color: #991B1B;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <p style="margin: 0; font-size: 14px;">Error loading property details.</p>
                        </div>
                    `;
                }
            } else {
                propertyInfoContainer.innerHTML = `
                    <div style="padding: 24px; text-align: center; background: #EFF6FF; border-radius: 8px; color: #1E40AF;">
                        <i class="fas fa-info-circle" style="font-size: 32px; margin-bottom: 12px;"></i>
                        <p style="margin: 0; font-size: 14px;">No specific property selected. Submitting a general application.</p>
                    </div>
                `;
            }

            // Handle form submission
            const applicationForm = document.getElementById('property-application-form');
            if (applicationForm) {
                applicationForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn.disabled) return;

                    const originalBtnContent = submitBtn.innerHTML;

                    // Get form data directly from inputs to handle mapping
                    const rawFormData = new FormData(this);

                    // Create formatted data for backend (camelCase)
                    const submissionData = new FormData();

                    const propertyTitleElement = document.querySelector('.property-title');
                    const fullPropertyName = propertyTitleElement ? propertyTitleElement.textContent : 'General Application';

                    if (propertyId) submissionData.append('propertyId', propertyId);
                    submissionData.append('propertyName', fullPropertyName);
                    submissionData.append('timestamp', new Date().toISOString());

                    // Map fields: Form (kebab-case) -> Backend (camelCase)
                    submissionData.append('applicantName', rawFormData.get('applicant-name'));
                    submissionData.append('applicantEmail', rawFormData.get('applicant-email'));
                    submissionData.append('applicantPhone', rawFormData.get('applicant-phone'));
                    submissionData.append('applicantIncome', rawFormData.get('applicant-income'));
                    submissionData.append('applicantAddress', rawFormData.get('applicant-address'));
                    submissionData.append('applicantCity', rawFormData.get('applicant-city'));
                    submissionData.append('applicantState', rawFormData.get('applicant-state'));
                    submissionData.append('applicantZip', rawFormData.get('applicant-zip'));
                    submissionData.append('applicantOccupants', rawFormData.get('applicant-occupants'));
                    submissionData.append('applicantEmployment', rawFormData.get('applicant-employment'));
                    submissionData.append('applicantMessage', rawFormData.get('applicant-message') || '');

                    // File Validation
                    const docId = document.getElementById('doc-id');
                    const docIncome = document.getElementById('doc-income');
                    const docOther = document.getElementById('doc-other');

                    const validateFile = (input) => {
                        if (input.files.length > 0) {
                            const file = input.files[0];
                            if (file.size > 5 * 1024 * 1024) { // 5MB
                                alert(`File ${file.name} is too large. Max size is 5MB.`);
                                return false;
                            }
                        }
                        return true;
                    };

                    if (!validateFile(docId) || !validateFile(docIncome)) {
                        return;
                    }

                    // Append files to submissionData
                    if (docId.files.length > 0) submissionData.append('doc-id', docId.files[0]);
                    if (docIncome.files.length > 0) submissionData.append('doc-income', docIncome.files[0]);

                    if (docOther.files.length > 0) {
                        for (let i = 0; i < docOther.files.length; i++) {
                            const file = docOther.files[i];
                            if (file.size > 5 * 1024 * 1024) {
                                alert(`File ${file.name} is too large. Max size is 5MB.`);
                                return;
                            }
                            submissionData.append('doc-other', file);
                        }
                    }

                    try {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner"></span> Submitting...';

                        // Send application to backend
                        const response = await fetch('/api/application', {
                            method: 'POST',
                            body: submissionData
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Redirect to success page
                            const firstName = rawFormData.get('applicant-name').split(' ')[0];
                            window.location.href = `application-success.html?name=${encodeURIComponent(firstName)}`;
                        } else {
                            alert('Error submitting application: ' + (result.message || 'Unknown error'));
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnContent;
                        }
                    } catch (error) {
                        console.error('Error submitting application:', error);
                        alert('Error submitting application. Please try again.');
                        const submitBtn = this.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Application';
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>