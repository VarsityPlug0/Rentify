<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Rentify</title>

    <!-- Modern CSS Framework -->
    <link rel="stylesheet" href="../modern-framework.css?v=2.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>

<body>
    <!-- Header Navigation -->
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Rentify</h1>
                        <p>Admin Panel</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="main-nav">
                    <a href="../index.html" class="nav-link">Public Site</a>
                    <button id="logout-btn" class="btn btn-outline">Logout</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Admin Dashboard -->
    <section class="admin-dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <p>Manage your rental properties and applications</p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-properties">0</div>
                        <div class="stat-title">Total Properties</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon accent">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="pending-applications">0</div>
                        <div class="stat-title">Pending Applications</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon warm">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="unread-messages">0</div>
                        <div class="stat-title">Unread Messages</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="actions-grid">
                    <button class="action-card" onclick="openAddPropertyModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add New Property</span>
                    </button>

                    <button class="action-card" onclick="loadApplications()">
                        <i class="fas fa-file-contract"></i>
                        <span>View Applications</span>
                    </button>

                    <button class="action-card" onclick="loadMessages()">
                        <i class="fas fa-envelope"></i>
                        <span>View Messages</span>
                    </button>
                </div>
            </div>

            <!-- Properties Management -->
            <div class="properties-management">
                <div class="section-header">
                    <h2>Manage Properties</h2>
                    <button class="btn btn-primary" onclick="openAddPropertyModal()">
                        <i class="fas fa-plus"></i> Add Property
                    </button>
                </div>

                <div class="properties-table">
                    <table id="properties-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="properties-table-body">
                            <!-- Properties will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Add/Edit Property Modal -->
    <div id="property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Property</h2>
                <button class="close-btn" onclick="closePropertyModal()">&times;</button>
            </div>

            <form id="property-form">
                <input type="hidden" id="property-id" name="id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Property Title *</label>
                        <input type="text" id="title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="location">Location *</label>
                        <input type="text" id="location" name="location" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Monthly Price *</label>
                        <input type="number" id="price" name="price" min="0" step="50" required>
                    </div>

                    <div class="form-group">
                        <label for="bedrooms">Bedrooms *</label>
                        <input type="number" id="bedrooms" name="bedrooms" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bathrooms">Bathrooms *</label>
                        <input type="number" id="bathrooms" name="bathrooms" min="0" step="0.5" required>
                    </div>

                    <div class="form-group">
                        <label for="squareFeet">Square Feet</label>
                        <input type="number" id="squareFeet" name="squareFeet" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>Property Images</label>
                    <div id="image-preview-container"
                        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>
                    <input type="hidden" id="images" name="images">
                    <input type="file" id="image-upload" accept="image/*" multiple onchange="handleImageUpload(this)">
                    <small class="text-muted">Upload images. They will appear in the preview above.</small>
                </div>

                <div class="form-group">
                    <label for="available">Available</label>
                    <select id="available" name="available">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="featured" name="featured"> Featured Property
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closePropertyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Rentify. Admin Panel.</p>
            </div>
        </div>
    </footer>

    <!-- App JavaScript -->
    <script>
        // Admin Panel Functionality
        document.addEventListener('DOMContentLoaded', async function () {
            // Check admin authentication
            await checkAdminAuth();

            // Load initial data
            await loadDashboardData();
            await loadProperties();

            // Setup form handlers
            setupFormHandlers();

            // Setup logout handler
            document.getElementById('logout-btn').addEventListener('click', logout);
        });

        // Centralized API Client
        async function apiCall(endpoint, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };

            // If body is FormData, delete Content-Type to let browser set boundary
            if (options.body instanceof FormData) {
                delete defaultHeaders['Content-Type'];
            }

            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                },
                credentials: 'include' // Always send cookies
            };

            try {
                const response = await fetch(endpoint, config);

                if (response.status === 401) {
                    console.warn('Session expired or unauthorized. Redirecting to login.');
                    window.location.href = 'login.html';
                    return null;
                }

                if (response.status === 403) {
                    throw new Error('Access denied. You do not have permission to perform this action.');
                }

                return response;
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                throw error;
            }
        }

        async function checkAdminAuth() {
            try {
                const response = await apiCall('/api/auth/status');
                if (!response) return; // Redirected

                const data = await response.json();

                if (!data.isAuthenticated || data.user.role !== 'admin') {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        async function loadDashboardData() {
            try {
                const response = await apiCall('/api/properties');
                if (!response) return;
                const data = await response.json();

                if (data.success) {
                    document.getElementById('total-properties').textContent = data.data.length;

                    // Load actual counts for applications and messages
                    try {
                        const applicationsResponse = await apiCall('/api/application');
                        if (applicationsResponse) {
                            const applicationsData = await applicationsResponse.json();
                            if (applicationsData.success) {
                                document.getElementById('pending-applications').textContent = applicationsData.data.filter(app => app.status === 'pending').length;
                            }
                        }
                    } catch (appError) {
                        console.error('Failed to load applications count:', appError);
                        document.getElementById('pending-applications').textContent = '0';
                    }

                    try {
                        const messagesResponse = await apiCall('/api/message');
                        if (messagesResponse) {
                            const messagesData = await messagesResponse.json();
                            if (messagesData.success) {
                                document.getElementById('unread-messages').textContent = messagesData.data.filter(msg => msg.status === 'unread').length;
                            }
                        }
                    } catch (msgError) {
                        console.error('Failed to load messages count:', msgError);
                        document.getElementById('unread-messages').textContent = '0';
                    }
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        async function loadProperties() {
            try {
                const response = await apiCall('/api/properties');
                if (!response) return;
                const data = await response.json();

                if (data.success) {
                    renderPropertiesTable(data.data);
                }
            } catch (error) {
                console.error('Failed to load properties:', error);
            }
        }

        function renderPropertiesTable(properties) {
            const tbody = document.getElementById('properties-table-body');
            tbody.innerHTML = properties.map(property => `
                <tr>
                    <td data-label="Title">${property.title}</td>
                    <td data-label="Location">${property.location}</td>
                    <td data-label="Price">$${property.price}/mo</td>
                    <td data-label="Status">
                        <span class="status-badge ${property.available ? 'available' : 'unavailable'}">
                            ${property.available ? 'Available' : 'Occupied'}
                        </span>
                    </td>
                    <td data-label="Actions">
                        <button class="btn btn-small btn-outline" onclick="editProperty(${property.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteProperty(${property.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function handleImageUpload(input) {
            const files = input.files;
            if (!files.length) return;

            const uploadedUrls = [];
            const currentImages = document.getElementById('images').value ? document.getElementById('images').value.split(',') : [];

            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('image', files[i]);

                try {
                    // apiCall handles headers, detecting FormData automatically
                    const response = await apiCall('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response) continue;

                    const result = await response.json();
                    if (result.success) {
                        uploadedUrls.push(result.url);
                        addImagePreview(result.url);
                    } else {
                        alert('Upload failed: ' + result.message);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Upload error');
                }
            }

            // Append new images to existing ones
            // Ensure we don't duplicate empty strings
            const allImages = [...currentImages.filter(i => i), ...uploadedUrls];
            document.getElementById('images').value = allImages.join(',');
            input.value = ''; // Reset
        }

        function addImagePreview(url) {
            const container = document.getElementById('image-preview-container');
            const div = document.createElement('div');
            div.style.position = 'relative';
            div.style.display = 'inline-block'; // Ensure proper spacing
            div.innerHTML = `
                <img src="${url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #dee2e6;">
                <button type="button" onclick="removeImage(this, '${url}')" 
                    style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border: 2px solid white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s;">
                    <i class="fas fa-trash" style="font-size: 12px;"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeImage(btn, url) {
            btn.parentElement.remove();
            const currentImages = document.getElementById('images').value.split(',');
            const newImages = currentImages.filter(img => img !== url && img !== '');
            document.getElementById('images').value = newImages.join(',');
        }

        function setupFormHandlers() {
            const propertyForm = document.getElementById('property-form');
            propertyForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(propertyForm);
                const propertyData = Object.fromEntries(formData);

                // Get ID from the hidden field
                const propertyId = document.getElementById('property-id').value;
                if (propertyId) {
                    propertyData.id = parseInt(propertyId);
                }

                // Convert checkbox value
                propertyData.featured = propertyForm.featured.checked;
                propertyData.available = propertyData.available === 'true';

                // Convert numeric values
                propertyData.price = parseInt(propertyData.price);
                propertyData.bedrooms = parseInt(propertyData.bedrooms);
                propertyData.bathrooms = parseFloat(propertyData.bathrooms);
                propertyData.squareFeet = parseInt(propertyData.squareFeet) || 0;

                // Process images array
                if (propertyData.images) {
                    propertyData.images = propertyData.images.split(',').map(img => img.trim()).filter(img => img);
                } else {
                    propertyData.images = [];
                }

                try {
                    // Convert ID to integer and check if it's valid
                    const propertyId = document.getElementById('property-id').value;
                    const hasId = propertyId && parseInt(propertyId) > 0;

                    const endpoint = hasId ?
                        `/api/properties/${parseInt(propertyId)}` :
                        '/api/properties';

                    const method = hasId ? 'PUT' : 'POST';

                    const response = await apiCall(endpoint, {
                        method: method,
                        body: JSON.stringify(propertyData)
                    });

                    if (!response) return;

                    const result = await response.json();

                    if (result.success) {
                        alert('Property saved successfully!');
                        closePropertyModal();
                        loadProperties();
                        loadDashboardData();
                    } else {
                        alert(result.message || 'Error saving property');
                    }
                } catch (error) {
                    console.error('Property save error:', error);
                    alert('Failed to save property. Please try again.');
                }
            });
        }

        function openAddPropertyModal() {
            document.getElementById('modal-title').textContent = 'Add New Property';
            document.getElementById('property-form').reset();
            document.getElementById('property-id').value = '';
            document.getElementById('image-preview-container').innerHTML = ''; // Clear previews
            document.getElementById('property-modal').style.display = 'block';
        }

        async function editProperty(propertyId) {
            try {
                const response = await apiCall(`/api/properties/${propertyId}`);
                if (!response) return;
                const data = await response.json();

                if (data.success) {
                    const property = data.data;
                    document.getElementById('modal-title').textContent = 'Edit Property';
                    document.getElementById('property-id').value = property.id;
                    document.getElementById('title').value = property.title;
                    document.getElementById('location').value = property.location;
                    document.getElementById('price').value = property.price;
                    document.getElementById('bedrooms').value = property.bedrooms;
                    document.getElementById('bathrooms').value = property.bathrooms;
                    document.getElementById('squareFeet').value = property.squareFeet || '';
                    document.getElementById('description').value = property.description;

                    // Handle images
                    document.getElementById('images').value = property.images ? property.images.join(',') : '';
                    document.getElementById('image-preview-container').innerHTML = '';
                    if (property.images) {
                        property.images.forEach(url => addImagePreview(url));
                    }

                    document.getElementById('available').value = property.available.toString();
                    document.getElementById('featured').checked = property.featured;

                    document.getElementById('property-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load property for editing:', error);
            }
        }

        async function deleteProperty(propertyId) {
            if (!confirm('Are you sure you want to delete this property?')) {
                return;
            }

            try {
                const response = await apiCall(`/api/properties/${propertyId}`, {
                    method: 'DELETE'
                });

                if (!response) return;

                const result = await response.json();

                if (result.success) {
                    alert('Property deleted successfully!');
                    loadProperties();
                    loadDashboardData();
                } else {
                    alert(result.message || 'Error deleting property');
                }
            } catch (error) {
                console.error('Property delete error:', error);
                alert('Failed to delete property. Please try again.');
            }
        }

        function closePropertyModal() {
            document.getElementById('property-modal').style.display = 'none';
        }

        // Application Management
        let currentAppFilter = 'pending';

        async function openApplicationsModal() {
            // Create modal structure
            const modalId = 'applications-modal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.position = 'fixed';
                modal.style.zIndex = '1000';
                modal.style.left = '0';
                modal.style.top = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
                <div style="background:white; margin:2% auto; padding:20px; width:90%; max-width:1100px; border-radius:8px; max-height:90vh; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="margin:0;">Rental Applications</h2>
                        <button onclick="document.getElementById('${modalId}').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
                    </div>

                    <!-- Tabs -->
                    <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #dee2e6;">
                        <button onclick="switchAppTab('pending')" id="tab-pending" class="tab-btn active" style="padding:10px 20px; border:none; background:none; cursor:pointer; font-weight:600; border-bottom:2px solid #667eea;">Pending</button>
                        <button onclick="switchAppTab('approved')" id="tab-approved" class="tab-btn" style="padding:10px 20px; border:none; background:none; cursor:pointer; color:#6c757d;">Approved</button>
                        <button onclick="switchAppTab('rejected')" id="tab-rejected" class="tab-btn" style="padding:10px 20px; border:none; background:none; cursor:pointer; color:#6c757d;">Declined</button>
                        <button onclick="switchAppTab('all')" id="tab-all" class="tab-btn" style="padding:10px 20px; border:none; background:none; cursor:pointer; color:#6c757d;">All History</button>
                    </div>

                    <div id="applications-list-container" style="overflow-y:auto; flex-grow:1;">
                        <div style="text-align:center; padding:40px;">
                            <i class="fas fa-spinner fa-spin fa-2x" style="color:#667eea;"></i>
                        </div>
                    </div>
                </div>
            `;

            // Load default tab
            switchAppTab('pending');
        }

        async function switchAppTab(status) {
            currentAppFilter = status;

            // Update tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottom = 'none';
                btn.style.color = '#6c757d';
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`tab-${status === 'all' ? 'all' : status}`);
            if (activeBtn) {
                activeBtn.style.borderBottom = '2px solid #667eea';
                activeBtn.style.color = '#2d3748';
                activeBtn.classList.add('active');
            }

            await loadApplicationsList(status);
        }

        async function loadApplicationsList(status) {
            const container = document.getElementById('applications-list-container');
            container.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:#667eea;"></i></div>';

            try {
                let url = '/api/application';
                if (status !== 'all') {
                    url += `?status=${status}`;
                }

                const response = await apiCall(url);
                if (!response) return; // Authentication failure handled by apiCall

                const data = await response.json();

                if (data.success) {
                    if (data.data.length === 0) {
                        container.innerHTML = `
                            <div style="text-align:center; padding:40px; color:#6c757d;">
                                <i class="fas fa-inbox fa-3x" style="margin-bottom:15px; opacity:0.5;"></i>
                                <p>No ${status === 'all' ? '' : status} applications found.</p>
                            </div>
                        `;
                        return;
                    }

                    let tableContent = `
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8f9fa; text-align:left;">
                                    <th style="padding:12px; border-bottom:2px solid #dee2e6;">Date</th>
                                    <th style="padding:12px; border-bottom:2px solid #dee2e6;">Applicant</th>
                                    <th style="padding:12px; border-bottom:2px solid #dee2e6;">Property</th>
                                    <th style="padding:12px; border-bottom:2px solid #dee2e6;">Contact</th>
                                    <th style="padding:12px; border-bottom:2px solid #dee2e6;">Income</th>
                                    ${status === 'all' ? '<th style="padding:12px; border-bottom:2px solid #dee2e6;">Status</th>' : ''}
                                    <th style="padding:12px; border-bottom:2px solid #dee2e6; text-align:right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.data.forEach(app => {
                        const date = new Date(app.createdAt).toLocaleDateString();
                        const statusBadge = `<span class="status-badge ${app.status}">${app.status}</span>`;

                        let actions = '';
                        if (app.status === 'pending') {
                            actions = `
                                <button onclick="viewApplicationDetails(${app.id})" class="btn btn-small btn-outline" style="margin-right:5px;">
                                    View Details
                                </button>
                                <button onclick="optimisticUpdate(${app.id}, 'approved')" class="btn btn-small btn-primary" style="margin-right:5px;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button onclick="declineApplication(${app.id})" class="btn btn-small btn-danger">
                                    <i class="fas fa-times"></i> Decline
                                </button>
                            `;
                        } else {
                            actions = `<button onclick="viewApplicationDetails(${app.id})" class="btn btn-small btn-outline">View Details</button>`;
                        }

                        tableContent += `
                            <tr id="app-row-${app.id}" style="border-bottom:1px solid #dee2e6;">
                                <td style="padding:12px;">${date}</td>
                                <td style="padding:12px;">
                                    <strong>${app.applicantName}</strong><br>
                                    <small class="text-muted">${app.applicantOccupants} Occupants</small>
                                </td>
                                <td style="padding:12px;">ID: ${app.propertyId}</td>
                                <td style="padding:12px;">
                                    ${app.applicantEmail}<br>
                                    ${app.applicantPhone}
                                </td>
                                <td style="padding:12px;">$${app.applicantIncome}/yr</td>
                                ${status === 'all' ? `<td style="padding:12px;">${statusBadge}</td>` : ''}
                                <td style="padding:12px; text-align:right;">
                                    ${actions}
                                </td>
                            </tr>
                        `;
                    });

                    tableContent += '</tbody></table>';
                    container.innerHTML = tableContent;
                }
            } catch (error) {
                console.error('Error loading applications:', error);

                // Show user friendly error in list
                if (error.message.includes('Access denied') || error.message.includes('Authentication required')) {
                    container.innerHTML = '<div style="color:red; text-align:center; padding:20px;">Session expired. Please <a href="login.html">log in again</a>.</div>';
                } else {
                    container.innerHTML = '<div style="color:red; text-align:center;">Failed to load applications.</div>';
                }
            }
        }

        function declineApplication(id) {
            // Simple prompt for now, could be a modal
            // const reason = prompt("Enter reason for declining (optional):");
            // if (reason !== null) {
            optimisticUpdate(id, 'rejected'); // API uses 'rejected', UI uses 'Declined'
            // }
        }

        async function optimisticUpdate(id, newStatus) {
            const row = document.getElementById(`app-row-${id}`);

            // 1. Optimistic UI Update
            if (row) {
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(20px)';
                // Don't remove immediately, hide it first. Remove only if success or after longer timeout
                // Actually, for better UX, we hide it now, and if error, show it again.
                row.style.display = 'none';
            }

            // 2. API Call
            try {
                const response = await apiCall(`/api/application/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: newStatus
                    })
                });

                if (!response) throw new Error('Authentication required');

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                // Success - completely remove
                if (row) row.remove();

                // Update dashboard counters in background
                loadDashboardData();

            } catch (error) {
                console.error('Update failed:', error);
                alert(`Failed to update application status: ${error.message}`);

                // Rollback: Re-show the item
                if (row) {
                    row.style.display = ''; // Restore display
                    row.style.opacity = '1';
                    row.style.transform = 'none';
                }

                // If it was auth error, list reload will handle showing login link
                if (error.message.includes('Authentication')) {
                    loadApplicationsList(currentAppFilter);
                }
            }
        }

        async function viewApplicationDetails(id) {
            try {
                // If we already have the data in the list, we could use that, but fetching ensures freshness
                // Since our list API might not return full details (like message), it's safer to fetch by ID if we had a detail endpoint
                // For now, our list endpoint returns everything, but let's see if we can find it in the current data or re-fetch

                // Since we don't have a specific single-application API endpoint exposed in our client code yet (Service has getById),
                // we'll filter from the list if we can, or just re-fetch the list.
                // Actually, the service I saw earlier has getById, and the routes usually expose it.
                // Let's try /api/application/:id first.

                const response = await apiCall(`/api/application/${id}`); // Assuming this endpoint works based on standard REST patterns
                if (!response) return;

                // If specific endpoint fails (404), fallback to finding in list might be tricky if we don't have the list data accessible globally.
                // But let's assume standard API design.

                const data = await response.json();

                if (data.success) {
                    openApplicationDetailsModal(data.data);
                } else {
                    // Fallback to finding it in the DOM if API fails or isn't implemented?
                    // No, let's error handling.
                    alert('Failed to load application details: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading application details:', error);

                // Fallback: Check if we have the data in a global variable or simpler way?
                // For now just alert.
                alert('Error loading details. Please try again.');
            }
        }

        function openApplicationDetailsModal(app) {
            const modalId = 'application-details-modal';
            let modal = document.getElementById(modalId);

            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.zIndex = '1100'; // Higher than list modal
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';

            const date = new Date(app.createdAt).toLocaleString();
            const updateDate = new Date(app.updatedAt).toLocaleString();

            modal.innerHTML = `
                <div style="background:white; margin:5% auto; padding:30px; width:90%; max-width:800px; border-radius:8px; max-height:90vh; overflow-y:auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <div>
                            <h2 style="margin:0; color:#2d3748;">Application Details</h2>
                            <span class="status-badge ${app.status}" style="font-size:0.9rem; margin-top:5px; display:inline-block;">${app.status.toUpperCase()}</span>
                        </div>
                        <button onclick="document.getElementById('${modalId}').remove()" style="background:none; border:none; font-size:2rem; cursor:pointer; color:#a0aec0;">&times;</button>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                        <div style="background:#f8f9fa; padding:15px; border-radius:6px;">
                            <h3 style="margin-top:0; font-size:1.1rem; color:#4a5568; border-bottom:1px solid #e2e8f0; padding-bottom:10px; margin-bottom:10px;">Applicant Information</h3>
                            <p style="margin:5px 0;"><strong>Name:</strong> ${app.applicantName}</p>
                            <p style="margin:5px 0;"><strong>Email:</strong> <a href="mailto:${app.applicantEmail}">${app.applicantEmail}</a></p>
                            <p style="margin:5px 0;"><strong>Phone:</strong> ${app.applicantPhone}</p>
                            <p style="margin:5px 0;"><strong>Annual Income:</strong> $${app.applicantIncome.toLocaleString()}</p>
                            <p style="margin:5px 0;"><strong>Occupants:</strong> ${app.applicantOccupants}</p>
                        </div>

                        <div style="background:#f8f9fa; padding:15px; border-radius:6px;">
                            <h3 style="margin-top:0; font-size:1.1rem; color:#4a5568; border-bottom:1px solid #e2e8f0; padding-bottom:10px; margin-bottom:10px;">Application Status</h3>
                            <p style="margin:5px 0;"><strong>Property ID:</strong> ${app.propertyId}</p>
                            <p style="margin:5px 0;"><strong>Submitted:</strong> ${date}</p>
                            <p style="margin:5px 0;"><strong>Last Updated:</strong> ${updateDate}</p>
                            <p style="margin:5px 0;"><strong>Application ID:</strong> #${app.id}</p>
                        </div>
                    </div>

                    <div style="background:#fff; border:1px solid #e2e8f0; padding:20px; border-radius:6px; margin-bottom:20px;">
                        <h3 style="margin-top:0; font-size:1.1rem; color:#4a5568; margin-bottom:10px;">Applicant Message</h3>
                        <p style="margin:0; line-height:1.6; color:#4a5568; white-space: pre-wrap;">${app.message || 'No message provided.'}</p>
                    </div>

                    ${app.documents && app.documents.length > 0 ? `
                    <div style="background:#fff; border:1px solid #e2e8f0; padding:20px; border-radius:6px; margin-bottom:20px;">
                         <h3 style="margin-top:0; font-size:1.1rem; color:#4a5568; border-bottom:1px solid #e2e8f0; padding-bottom:10px; margin-bottom:15px;">Submitted Documents</h3>
                         <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                            ${app.documents.map(doc => `
                                <a href="/${doc.url}" target="_blank" style="display:flex; align-items:center; padding:12px; border:1px solid #e2e8f0; border-radius:6px; text-decoration:none; color:#4a5568; transition:all 0.2s;" onmouseover="this.style.borderColor='#667eea';this.style.background='#f7fafc'" onmouseout="this.style.borderColor='#e2e8f0';this.style.background='white'">
                                    <div style="background:#edf2f7; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:12px;">
                                        <i class="fas ${doc.name.endsWith('.pdf') ? 'fa-file-pdf' : 'fa-file-image'}" style="color:${doc.name.endsWith('.pdf') ? '#e53e3e' : '#3182ce'}"></i>
                                    </div>
                                    <div style="overflow:hidden;">
                                        <div style="font-weight:600; font-size:0.9rem;">${doc.type}</div>
                                        <div style="font-size:0.8rem; color:#718096; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${doc.name}</div>
                                    </div>
                                </a>
                            `).join('')}
                         </div>
                    </div>
                    ` : ''}

                    ${app.adminNotes ? `
                    <div style="background:#ebf8ff; border:1px solid #bee3f8; padding:20px; border-radius:6px; margin-bottom:20px;">
                        <h3 style="margin-top:0; font-size:1.1rem; color:#2c5282; margin-bottom:10px;">Admin Notes</h3>
                        <p style="margin:0; line-height:1.6; color:#2c5282;">${app.adminNotes}</p>
                    </div>
                    ` : ''}

                    <div style="display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #eee; padding-top:20px;">
                        ${app.status === 'pending' ? `
                            <button onclick="optimisticUpdate(${app.id}, 'approved'); document.getElementById('${modalId}').remove()" class="btn btn-primary">Approve Application</button>
                            <button onclick="declineApplication(${app.id}); document.getElementById('${modalId}').remove()" class="btn btn-danger">Decline Application</button>
                        ` : ''}
                        <button onclick="document.getElementById('${modalId}').remove()" class="btn btn-outline">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Renamed function mapping for existing button
        function loadApplications() {
            openApplicationsModal();
        }

        async function loadMessages() {
            try {
                const response = await apiCall('/api/message');
                if (!response) return;
                const data = await response.json();

                if (data.success) {
                    // Update dashboard count
                    document.getElementById('unread-messages').textContent = data.data.filter(msg => msg.status === 'unread').length;

                    // Create a temporary modal to show messages
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'block';
                    modal.style.position = 'fixed';
                    modal.style.zIndex = '1000';
                    modal.style.left = '0';
                    modal.style.top = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';

                    // Build table content with proper escaping
                    let tableRows = '';
                    data.data.forEach(msg => {
                        tableRows += `
                            <tr style="border-bottom:1px solid #dee2e6;">
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.id}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.name}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.email}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.subject}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">
                                    <span class="status-badge ${msg.status === 'unread' ? 'pending' : msg.status === 'read' ? 'approved' : 'completed'}">
                                        ${msg.status.charAt(0).toUpperCase() + msg.status.slice(1)}
                                    </span>
                                </td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${new Date(msg.createdAt).toLocaleDateString()}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">
                                    <button class="btn btn-small btn-outline" onclick="updateMessageStatus(${msg.id}, 'read')">Mark Read</button>
                                    <button class="btn btn-small btn-primary" onclick="updateMessageStatus(${msg.id}, 'archived')">Archive</button>
                                </td>
                            </tr>
                        `;
                    });

                    modal.innerHTML = `
                        <div style="background:white; margin:5% auto; padding:20px; width:80%; max-width:900px; border-radius:8px; max-height:80vh; overflow-y:auto;">
                            <h2>Contact Messages</h2>
                            <div style="margin-top:15px;">
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="float:right; background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Close</button>
                                <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                                    <thead>
                                        <tr style="background:#f8f9fa;">
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">ID</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Name</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Email</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Subject</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Status</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Date</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } else {
                    alert('Error loading messages: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
                alert('Failed to load messages. Please try again.');
            }
        }

        // Add helper functions for updating statuses
        async function updateApplicationStatus(appId, status) {
            try {
                const response = await fetch(`/api/application/${appId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Application ${status} successfully!`);
                    // Reload applications to reflect changes
                    loadApplications();
                } else {
                    alert('Error updating application: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to update application status:', error);
                alert('Failed to update application status. Please try again.');
            }
        }

        async function updateMessageStatus(msgId, status) {
            try {
                const response = await fetch(`/api/message/${msgId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Message ${status} successfully!`);
                    // Reload messages to reflect changes
                    loadMessages();
                } else {
                    alert('Error updating message: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to update message status:', error);
                alert('Failed to update message status. Please try again.');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('property-modal');
            if (event.target == modal) {
                closePropertyModal();
            }
        }
    </script>
    <style>
        .demo-credentials {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* Responsive Table for Mobile */
        @media screen and (max-width: 768px) {
            .properties-table table {
                border: 0;
            }

            .properties-table thead {
                border: none;
                clip: rect(0 0 0 0);
                height: 1px;
                margin: -1px;
                overflow: hidden;
                padding: 0;
                position: absolute;
                width: 1px;
            }

            .properties-table tr {
                background-color: #fff;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                display: block;
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .properties-table td {
                border-bottom: 1px solid #f3f4f6;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                text-align: right;
            }

            .properties-table td:last-child {
                border-bottom: 0;
                justify-content: flex-end;
                gap: 0.5rem;
            }

            .properties-table td::before {
                content: attr(data-label);
                float: left;
                font-weight: 600;
                color: #4b5563;
                text-transform: uppercase;
                font-size: 0.75rem;
                margin-right: 1rem;
            }

            /* Specific cell styling for better mobile look */
            .properties-table td:first-child {
                font-weight: 700;
                color: var(--primary-600);
                font-size: 1.1rem;
            }
        }
    </style>
</body>

</html>