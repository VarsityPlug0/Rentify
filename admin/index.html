<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ForRentbyOwner</title>

    <!-- Modern CSS Framework -->
    <link rel="stylesheet" href="../modern-framework.css?v=2.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>

<body>
    <!-- Header Navigation -->
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="logo-text">
                        <h1>ForRentbyOwner</h1>
                        <p>Admin Panel</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="main-nav">
                    <a href="../index.html" class="nav-link">Public Site</a>
                    <button id="logout-btn" class="btn btn-outline">Logout</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Admin Dashboard -->
    <section class="admin-dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <p>Manage your rental properties and applications</p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-properties">0</div>
                        <div class="stat-title">Total Properties</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon accent">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="pending-applications">0</div>
                        <div class="stat-title">Pending Applications</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon warm">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="unread-messages">0</div>
                        <div class="stat-title">Unread Messages</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="actions-grid">
                    <button class="action-card" onclick="openAddPropertyModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add New Property</span>
                    </button>

                    <button class="action-card" onclick="loadApplications()">
                        <i class="fas fa-file-contract"></i>
                        <span>View Applications</span>
                    </button>

                    <button class="action-card" onclick="loadMessages()">
                        <i class="fas fa-envelope"></i>
                        <span>View Messages</span>
                    </button>
                </div>
            </div>

            <!-- Properties Management -->
            <div class="properties-management">
                <div class="section-header">
                    <h2>Manage Properties</h2>
                    <button class="btn btn-primary" onclick="openAddPropertyModal()">
                        <i class="fas fa-plus"></i> Add Property
                    </button>
                </div>

                <div class="properties-table">
                    <table id="properties-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="properties-table-body">
                            <!-- Properties will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Add/Edit Property Modal -->
    <div id="property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Property</h2>
                <button class="close-btn" onclick="closePropertyModal()">&times;</button>
            </div>

            <form id="property-form">
                <input type="hidden" id="property-id" name="id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Property Title *</label>
                        <input type="text" id="title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="location">Location *</label>
                        <input type="text" id="location" name="location" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Monthly Price *</label>
                        <input type="number" id="price" name="price" min="0" step="50" required>
                    </div>

                    <div class="form-group">
                        <label for="bedrooms">Bedrooms *</label>
                        <input type="number" id="bedrooms" name="bedrooms" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bathrooms">Bathrooms *</label>
                        <input type="number" id="bathrooms" name="bathrooms" min="0" step="0.5" required>
                    </div>

                    <div class="form-group">
                        <label for="squareFeet">Square Feet</label>
                        <input type="number" id="squareFeet" name="squareFeet" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>Property Images</label>
                    <div id="image-preview-container"
                        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>
                    <input type="hidden" id="images" name="images">
                    <input type="file" id="image-upload" accept="image/*" multiple onchange="handleImageUpload(this)">
                    <small class="text-muted">Upload images. They will appear in the preview above.</small>
                </div>

                <div class="form-group">
                    <label for="available">Available</label>
                    <select id="available" name="available">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="featured" name="featured"> Featured Property
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closePropertyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 ForRentbyOwner. Admin Panel.</p>
            </div>
        </div>
    </footer>

    <!-- App JavaScript -->
    <script>
        // Admin Panel Functionality
        document.addEventListener('DOMContentLoaded', async function () {
            // Check admin authentication
            await checkAdminAuth();

            // Load initial data
            await loadDashboardData();
            await loadProperties();

            // Setup form handlers
            setupFormHandlers();

            // Setup logout handler
            document.getElementById('logout-btn').addEventListener('click', logout);
        });

        async function checkAdminAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (!data.isAuthenticated || data.user.role !== 'admin') {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('total-properties').textContent = data.data.length;

                    // Load actual counts for applications and messages
                    try {
                        const applicationsResponse = await fetch('/api/application');
                        const applicationsData = await applicationsResponse.json();
                        if (applicationsData.success) {
                            document.getElementById('pending-applications').textContent = applicationsData.data.filter(app => app.status === 'pending').length;
                        }
                    } catch (appError) {
                        console.error('Failed to load applications count:', appError);
                        document.getElementById('pending-applications').textContent = '0';
                    }

                    try {
                        const messagesResponse = await fetch('/api/message');
                        const messagesData = await messagesResponse.json();
                        if (messagesData.success) {
                            document.getElementById('unread-messages').textContent = messagesData.data.filter(msg => msg.status === 'unread').length;
                        }
                    } catch (msgError) {
                        console.error('Failed to load messages count:', msgError);
                        document.getElementById('unread-messages').textContent = '0';
                    }
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        async function loadProperties() {
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();

                if (data.success) {
                    renderPropertiesTable(data.data);
                }
            } catch (error) {
                console.error('Failed to load properties:', error);
            }
        }

        function renderPropertiesTable(properties) {
            const tbody = document.getElementById('properties-table-body');
            tbody.innerHTML = properties.map(property => `
                <tr>
                    <td>${property.title}</td>
                    <td>${property.location}</td>
                    <td>$${property.price}/mo</td>
                    <td>
                        <span class="status-badge ${property.available ? 'available' : 'unavailable'}">
                            ${property.available ? 'Available' : 'Occupied'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small btn-outline" onclick="editProperty(${property.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteProperty(${property.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function handleImageUpload(input) {
            const files = input.files;
            if (!files.length) return;

            const uploadedUrls = [];
            const currentImages = document.getElementById('images').value ? document.getElementById('images').value.split(',') : [];

            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('image', files[i]);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        uploadedUrls.push(result.url);
                        addImagePreview(result.url);
                    } else {
                        alert('Upload failed: ' + result.message);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Upload error');
                }
            }

            // Append new images to existing ones
            // Ensure we don't duplicate empty strings
            const allImages = [...currentImages.filter(i => i), ...uploadedUrls];
            document.getElementById('images').value = allImages.join(',');
            input.value = ''; // Reset
        }

        function addImagePreview(url) {
            const container = document.getElementById('image-preview-container');
            const div = document.createElement('div');
            div.style.position = 'relative';
            div.innerHTML = `
                <img src="${url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;">
                <button type="button" onclick="removeImage(this, '${url}')" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; cursor: pointer;">&times;</button>
            `;
            container.appendChild(div);
        }

        function removeImage(btn, url) {
            btn.parentElement.remove();
            const currentImages = document.getElementById('images').value.split(',');
            const newImages = currentImages.filter(img => img !== url && img !== '');
            document.getElementById('images').value = newImages.join(',');
        }

        function setupFormHandlers() {
            const propertyForm = document.getElementById('property-form');
            propertyForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(propertyForm);
                const propertyData = Object.fromEntries(formData);

                // Get ID from the hidden field
                const propertyId = document.getElementById('property-id').value;
                if (propertyId) {
                    propertyData.id = parseInt(propertyId);
                }

                // Convert checkbox value
                propertyData.featured = propertyForm.featured.checked;
                propertyData.available = propertyData.available === 'true';

                // Convert numeric values
                propertyData.price = parseInt(propertyData.price);
                propertyData.bedrooms = parseInt(propertyData.bedrooms);
                propertyData.bathrooms = parseFloat(propertyData.bathrooms);
                propertyData.squareFeet = parseInt(propertyData.squareFeet) || 0;

                // Process images array
                if (propertyData.images) {
                    propertyData.images = propertyData.images.split(',').map(img => img.trim()).filter(img => img);
                } else {
                    propertyData.images = [];
                }

                try {
                    // Convert ID to integer and check if it's valid
                    const propertyId = document.getElementById('property-id').value;
                    const hasId = propertyId && parseInt(propertyId) > 0;

                    const endpoint = hasId ?
                        `/api/properties/${parseInt(propertyId)}` :
                        '/api/properties';

                    const method = hasId ? 'PUT' : 'POST';

                    const response = await fetch(endpoint, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(propertyData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Property saved successfully!');
                        closePropertyModal();
                        loadProperties();
                        loadDashboardData();
                    } else {
                        alert(result.message || 'Error saving property');
                    }
                } catch (error) {
                    console.error('Property save error:', error);
                    alert('Failed to save property. Please try again.');
                }
            });
        }

        function openAddPropertyModal() {
            document.getElementById('modal-title').textContent = 'Add New Property';
            document.getElementById('property-form').reset();
            document.getElementById('property-id').value = '';
            document.getElementById('image-preview-container').innerHTML = ''; // Clear previews
            document.getElementById('property-modal').style.display = 'block';
        }

        async function editProperty(propertyId) {
            try {
                const response = await fetch(`/api/properties/${propertyId}`);
                const data = await response.json();

                if (data.success) {
                    const property = data.data;
                    document.getElementById('modal-title').textContent = 'Edit Property';
                    document.getElementById('property-id').value = property.id;
                    document.getElementById('title').value = property.title;
                    document.getElementById('location').value = property.location;
                    document.getElementById('price').value = property.price;
                    document.getElementById('bedrooms').value = property.bedrooms;
                    document.getElementById('bathrooms').value = property.bathrooms;
                    document.getElementById('squareFeet').value = property.squareFeet || '';
                    document.getElementById('description').value = property.description;

                    // Handle images
                    document.getElementById('images').value = property.images ? property.images.join(',') : '';
                    document.getElementById('image-preview-container').innerHTML = '';
                    if (property.images) {
                        property.images.forEach(url => addImagePreview(url));
                    }

                    document.getElementById('available').value = property.available.toString();
                    document.getElementById('featured').checked = property.featured;

                    document.getElementById('property-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load property for editing:', error);
            }
        }

        async function deleteProperty(propertyId) {
            if (!confirm('Are you sure you want to delete this property?')) {
                return;
            }

            try {
                const response = await fetch(`/api/properties/${propertyId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Property deleted successfully!');
                    loadProperties();
                    loadDashboardData();
                } else {
                    alert(result.message || 'Error deleting property');
                }
            } catch (error) {
                console.error('Property delete error:', error);
                alert('Failed to delete property. Please try again.');
            }
        }

        function closePropertyModal() {
            document.getElementById('property-modal').style.display = 'none';
        }

        async function loadApplications() {
            try {
                const response = await fetch('/api/application');
                const data = await response.json();

                if (data.success) {
                    // Update dashboard count
                    document.getElementById('pending-applications').textContent = data.data.filter(app => app.status === 'pending').length;

                    // Create a temporary modal to show applications
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'block';
                    modal.style.position = 'fixed';
                    modal.style.zIndex = '1000';
                    modal.style.left = '0';
                    modal.style.top = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';

                    // Build table content with proper escaping
                    let tableRows = '';
                    data.data.forEach(app => {
                        tableRows += `
                            <tr style="border-bottom:1px solid #dee2e6;">
                                <td style="padding:10px; border:1px solid #dee2e6;">${app.id}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${app.propertyId}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${app.applicantName}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${app.applicantEmail}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">
                                    <span class="status-badge ${app.status === 'pending' ? 'pending' : app.status === 'approved' ? 'approved' : 'rejected'}">
                                        ${app.status.charAt(0).toUpperCase() + app.status.slice(1)}
                                    </span>
                                </td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${new Date(app.createdAt).toLocaleDateString()}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">
                                    <button class="btn btn-small btn-outline" onclick="updateApplicationStatus(${app.id}, 'approved')">Approve</button>
                                    <button class="btn btn-small btn-danger" onclick="updateApplicationStatus(${app.id}, 'rejected')">Reject</button>
                                </td>
                            </tr>
                        `;
                    });

                    modal.innerHTML = `
                        <div style="background:white; margin:5% auto; padding:20px; width:80%; max-width:900px; border-radius:8px; max-height:80vh; overflow-y:auto;">
                            <h2>Rental Applications</h2>
                            <div style="margin-top:15px;">
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="float:right; background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Close</button>
                                <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                                    <thead>
                                        <tr style="background:#f8f9fa;">
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">ID</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Property</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Applicant</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Email</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Status</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Date</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } else {
                    alert('Error loading applications: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
                alert('Failed to load applications. Please try again.');
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/message');
                const data = await response.json();

                if (data.success) {
                    // Update dashboard count
                    document.getElementById('unread-messages').textContent = data.data.filter(msg => msg.status === 'unread').length;

                    // Create a temporary modal to show messages
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'block';
                    modal.style.position = 'fixed';
                    modal.style.zIndex = '1000';
                    modal.style.left = '0';
                    modal.style.top = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';

                    // Build table content with proper escaping
                    let tableRows = '';
                    data.data.forEach(msg => {
                        tableRows += `
                            <tr style="border-bottom:1px solid #dee2e6;">
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.id}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.name}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.email}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${msg.subject}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">
                                    <span class="status-badge ${msg.status === 'unread' ? 'pending' : msg.status === 'read' ? 'approved' : 'completed'}">
                                        ${msg.status.charAt(0).toUpperCase() + msg.status.slice(1)}
                                    </span>
                                </td>
                                <td style="padding:10px; border:1px solid #dee2e6;">${new Date(msg.createdAt).toLocaleDateString()}</td>
                                <td style="padding:10px; border:1px solid #dee2e6;">
                                    <button class="btn btn-small btn-outline" onclick="updateMessageStatus(${msg.id}, 'read')">Mark Read</button>
                                    <button class="btn btn-small btn-primary" onclick="updateMessageStatus(${msg.id}, 'archived')">Archive</button>
                                </td>
                            </tr>
                        `;
                    });

                    modal.innerHTML = `
                        <div style="background:white; margin:5% auto; padding:20px; width:80%; max-width:900px; border-radius:8px; max-height:80vh; overflow-y:auto;">
                            <h2>Contact Messages</h2>
                            <div style="margin-top:15px;">
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="float:right; background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Close</button>
                                <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                                    <thead>
                                        <tr style="background:#f8f9fa;">
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">ID</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Name</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Email</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Subject</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Status</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Date</th>
                                            <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } else {
                    alert('Error loading messages: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
                alert('Failed to load messages. Please try again.');
            }
        }

        // Add helper functions for updating statuses
        async function updateApplicationStatus(appId, status) {
            try {
                const response = await fetch(`/api/application/${appId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Application ${status} successfully!`);
                    // Reload applications to reflect changes
                    loadApplications();
                } else {
                    alert('Error updating application: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to update application status:', error);
                alert('Failed to update application status. Please try again.');
            }
        }

        async function updateMessageStatus(msgId, status) {
            try {
                const response = await fetch(`/api/message/${msgId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Message ${status} successfully!`);
                    // Reload messages to reflect changes
                    loadMessages();
                } else {
                    alert('Error updating message: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to update message status:', error);
                alert('Failed to update message status. Please try again.');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('property-modal');
            if (event.target == modal) {
                closePropertyModal();
            }
        }
    </script>
</body>

</html>